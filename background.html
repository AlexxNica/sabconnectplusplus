<html>
<head>
<script type="text/javascript" src="jquery-1.4.2.min.js"/>
<script type="text/javascript" src="common.js"/>
<script>
var gTimer;
var gSabInfo;

var globalContext = new Object();
globalContext.config = getAllPrefs();

$(document).ready(function() {
    setDefaults();
    startTimer();
});

function restartTimer() {
   startTimer(); 
}

function startTimer() {
    if(gTimer) {
        clearInterval(gTimer);
    } else {
        fetchInfo();
    }
    gTimer = setInterval(fetchInfo, getPref('refresh_rate')*1000);
    //gTimer = setInterval(fetchInfo, 5000);
}


function setDefaults() {
    if(!getPref('sab_url')) setPref('sab_url', 'http://localhost:8080/sabnzbd/');
    if(!getPref('api_key')) setPref('api_key', '');
    if(!getPref('http_user')) setPref('http_user', '');
    if(!getPref('http_pass')) setPref('http_pass', '');	
    if(!getPref('speedlog')) setPref('speedlog', []);
    if(!getPref('show_graph') == undefined) setPref('show_graph', 0);
    if(getPref('enable_newzbin') == undefined) setPref('enable_newzbin', 1);
    if(getPref('enable_tvnzb') == undefined) setPref('enable_tvnzb', 1);
    if(getPref('enable_nzbmatrix') == undefined) setPref('enable_nzbmatrix', 1);
    if(getPref('enable_nzbclub') == undefined) setPref('enable_nzbclub', 1);
	if(getPref('enable_bintube') == undefined) setPref('enable_bintube', 1); 
 
    // Force this back to 0 just incase
    getPref('skip_redraw', 0);
    
    if(getPref('refresh_rate') == undefined) setPref('refresh_rate', 15);
}

function addToSABnzbd(cb, nzburl, mode) {

    var sabApiUrl = constructApiUrl();
    var data = constructApiPost(true);
    data.mode = mode;
    data.name = nzburl;
	data.output = 'json';
    $.ajax({
        type: "GET",
        url: sabApiUrl,
		cache: false,
		username : getPref('http_user'),
		password : getPref('http_pass'),
        data: data,
        dataType: 'json',
        success: cb({'ret' : 'success', 'data' : data}),
        error: cb({'ret' : 'error'})
    });
	//fetchInfo(true);
}

/**
* Handles data sent via chrome.extension.sendRequest().
* @param request Object Data sent in the request.
* @param sender Object Origin of the request.
* @param sendResponse Function The method to call when the request completes.
*/
function onRequest(request, sender, sendResponse) {
	switch(request.action)
	{
		case 'getContext':
			sendResponse({value: globalContext});
			return;
		case 'reloadConfig':
			globalContext.config = getAllPrefs();
			break;
		case 'addToSABnzbd':
			console.log('add');
			addToSABnzbd(sendResponse, request.nzburl, request.mode);
			return;
	}
	sendResponse({});
	return;
};

// Wire up the listener.
chrome.extension.onRequest.addListener(onRequest);

</script>
</head>
<body></body>
</html>